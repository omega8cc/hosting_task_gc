<?php

/**
 * Implementation of hook_hosting_queues().
 *
 * Return a list of queues that this module needs to manage.
 */
function hosting_task_gc_hosting_queues() {
  $result = hosting_task_gc_count_sites();
  $row = db_fetch_object($result);
  $count = $row->num_sites;
  $queue['task_gc'] = array(
    'name' => t('Task GC'),
    'description' => t('Process the garbage collection of task logs.'),
    'type' => 'batch',  # run queue sequentially. always with the same parameters.
    'frequency' => strtotime("1 hour", 0),
    'min_threads' => 6,
    'max_threads' => 12,
    'threshold' => 100,
    'total_items' => $count,
    'singular' => t('site'),
    'plural' => t('sites'),
  );
  return $queue;
}

/**
 * The main queue callback for the backups.
 */
function hosting_task_gc_queue($count) {
  global $user;
  $old_user = $user;
  $user = user_load(1);
  $result = hosting_task_gc_list_sites();
  while ($site = db_fetch_object($result)) {
    $query = "SELECT nid FROM {hosting_task} WHERE rid = %d";
    $tasks_to_remove = db_query($query, $site->nid);
    while ($row = db_fetch_object($tasks_to_remove)) {
      node_delete($row->nid);
    }
  }
  $user = $old_user;
  $query = "SELECT DISTINCT h.vid FROM {hosting_task_log} h LEFT OUTER JOIN {node_revisions} n ON h.vid = n.vid WHERE n.vid IS NULL LIMIT 100";
  $result = db_query($query);
  while ($revision = db_fetch_object($result)) {
    $query = "DELETE FROM {hosting_task_log} WHERE vid = %d";
    db_query($query, $revision->vid);
    $num = db_affected_rows();
    watchdog('hosting_task_gc', 'Deleted @num orphaned task log entries with vid @vid.', array('@num' => $num, '@vid' => $revision->vid));
  }
}

function hosting_task_gc_list_sites() {
  $query = "SELECT DISTINCT s.nid FROM {hosting_site} s INNER JOIN {hosting_task} t ON s.nid = t.rid WHERE s.status = %d LIMIT 5";
  return db_query($query, HOSTING_SITE_DELETED);
}

function hosting_task_gc_count_sites() {
  $query = "SELECT COUNT(DISTINCT s.nid) AS num_sites FROM {hosting_site} s INNER JOIN {hosting_task} t ON s.nid = t.rid WHERE s.status = %d";
  return db_query($query, HOSTING_SITE_DELETED);
}
